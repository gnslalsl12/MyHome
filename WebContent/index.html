<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css' rel='stylesheet' integrity='sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx' crossorigin='anonymous'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
  <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js' integrity='sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa' crossorigin='anonymous'></script>
  <title>Document</title>

  <style>
    ul{
      list-style:none;
    }
  </style>
</head>
<body>
  <div class="header">
    <nav class="navbar" style="background-color: skyblue;">
      <div class="container">
        <div style="padding-left: 80%;"> 
          <button type="button" onclick="location.href='./sign_up.html'" id="prelogin1" class="btn btn-primary">회원가입</button>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" id="prelogin2" data-bs-target="#loginModal">로그인</button>
          <button type="button" onclick="location.href='./sign_up.html'" class="btn btn-primary" id="login1" style="display: none;">회원정보</button>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal" id="login2" style="display: none;">로그아웃</button>
        </div>
      </div>
    </nav>

    <!-- Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">로그인해주세요
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form class="form-floating mb-3" action="#" id="loginForm">
              <div class="form-floating mb-3">
                <input type="email" class="form-control" id="floatingInput" placeholder="name@example.com">
                <label for="floatingInput">아이디를 입력하세요</label>
              </div>
              <div class="form-floating">
                <input type="password" class="form-control" id="floatingPassword" placeholder="Password">
                <label for="floatingPassword">비밀번호를 입력하세요</label>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                  <button type="button" class="btn btn-primary" onclick="location.href='./index.html'" id="b-login">로그인</button>
                </div>
              </div>
            </form>
          </div>
          
        </div>
      </div>
    </div>
    
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
          <a class="navbar-brand" href="/index.html"><img src="./img/aaaa.jpg" alt="" width="150" height="150"></a>
          <div class="collapse navbar-collapse" id="navbarNav" style="padding-left: 70%;">
              <ul class="navbar-nav">
                  <li class="nav-item">
                      <a class="nav-link active" aria-current="page" href="#">공지사항</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link active" aria-current="page" href="#">오늘의 뉴스</a>
                  </li>
              </ul>
          </div>
      </div>
  </nav>
  </div>
  
  <nav>
    <div class="container-fluid" style="background-color: skyblue; height: 70px;">
      <div class="container">
        <h2 style="color: white; text-align: center; padding-top: 15px;">Where is my home~</h2>
      </div>
    </div>
    <div class="select_place" style="background-color: #e3f2fd; padding-top: 30px; padding-bottom: 25px;">
      <div class="container">
        <span class="align-middle">
          <div class="row col-md-12 justify-content-center mb-2">
            <div class="form-group col-md-2">
              <select class="form-select bg-secondary text-light" id="sido">
                <option value="">도/광역시</option>
              </select>
            </div>
            <div class="form-group col-md-2">
              <select class="form-select bg-secondary text-light" id="gugun">
                <option value="">시/구/군</option>
              </select>
            </div>
            <div class="form-group col-md-2">
              <select class="form-select bg-secondary text-light" id="dong">
                <option value="">동</option>
              </select>
            </div>
            <div class="form-group col-md-2">
              <select class="form-select bg-dark text-light" id="year"></select>
            </div>
            <div class="form-group col-md-2">
              <select class="form-select bg-dark text-light" id="month">
                <option value="">매매월선택</option>
              </select>
            </div>
            <div class="form-group col-md-2">
              <button type="button" id="list-btn" class="btn btn-outline-primary">
                아파트매매정보
              </button>
            </div>
          </div>
        </span>
        
        <div>
          <div class="row">
            <div class="col">
              <table class="table table-hover text-center" id="t" style="display: none">
                <tr>
                  <th>아파트이름</th>
                  <th>층</th>
                  <th>면적</th>
                  <th>법정동</th>
                  <th>거래금액</th>
                </tr>
                <tbody id="aptlist"></tbody>
              </table>
            </div>
            <div class="col">
              <div id="map" style="width: 100%; height: 500px"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </nav>    











  <footer id="footer" class="clearfix " style="margin-top: 60px;">

    <!-- .footer start -->
    <!-- ================ -->
    <div class="footer">
      <div class="container">
        <div class="footer-inner">
          <div class="row">
           <div class="col-md-1">
              <div class="footer-content">
                <img alt="" src="./img/logo.png"  width="100">
              </div>
            </div>
            <div class="col-md-8">
              <div class="footer-content">
                <h2 class="title">Find Us</h2>
                <div class="separator-2"></div>
                <ul class="list-icons">
                  <li><i class="bi-geo-alt-fill" style="margin-right: 5px;"></i> (SSAFY) 서울시 강남구  테헤란로 멀티스퀘어</li>
                  <li><i class="bi-telephone-forward-fill" style="margin-right: 5px;"></i> 1544-9001</li>
                  <li><i class="bi-envelope-fill" style="margin-right: 10px;"></i><a href="#">admin@ssafy.com</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- .footer end -->

    <!-- .subfooter start -->
    <!-- ================ -->
    <div class="subfooter">
      <div class="container">
        <div class="subfooter-inner">
          <div class="row">
            <div class="col-md-12">
              <p class="text-center">Copyright by SSAFY. All rights reserved.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- .subfooter end -->

  </footer>
<!-- footer end -->
</div>
<script src="./js/main.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=	57dd21f3fc158412d95faecd7bab8cf2&libraries=services"></script>
<script>
  ///////////////////////// 아파트 매매 정보 /////////////////////////
  document.querySelector("#list-btn").addEventListener("click", function () {
    let url =
      "http://openapi.molit.go.kr/OpenAPI_ToolInstallPackage/service/rest/RTMSOBJSvc/getRTMSDataSvcAptTradeDev";
    let gugunSel = document.querySelector("#gugun");
    let regCode = gugunSel[gugunSel.selectedIndex].value.substr(0, 5);
    let yearSel = document.querySelector("#year");
    let year = yearSel[yearSel.selectedIndex].value;
    let monthSel = document.querySelector("#month");
    let month = monthSel[monthSel.selectedIndex].value;
    let dealYM = year + month;

    let dongSel = document.querySelector("#dong");
    let dong = dongSel[dongSel.selectedIndex].text;

    let queryParams =
      encodeURIComponent("serviceKey") + "=" + "JM6smyrxzJKiJ4g3via953zrnzXuffKV4wpji3QJgOPr%2Bt8TXhjSAWuVzeW0FaeiKTC7StfYsztzS9iw0ev%2Bjw%3D%3D"; /*Service Key*/
    queryParams +=
      "&" +
      encodeURIComponent("LAWD_CD") +
      "=" +
      encodeURIComponent(regCode); /*아파트소재 구군*/
    queryParams +=
      "&" + encodeURIComponent("DEAL_YMD") + "=" + encodeURIComponent(dealYM); /*조회년월*/
    queryParams +=
      "&" + encodeURIComponent("pageNo") + "=" + encodeURIComponent("1"); /*페이지번호*/
    queryParams +=
      "&" + encodeURIComponent("numOfRows") + "=" + encodeURIComponent("30"); /*페이지당건수*/

    fetch(`${url}?${queryParams}`)
      .then((response) => response.text())
      .then((data) => {
        makeList(data)
      });
  });

  // <거래금액>   170,000</거래금액><거래유형> </거래유형><건축년도>2011</건축년도><년>2021</년><도로명>소공로</도로명><도로명건물본번호코드>00035</도로명건물본번호코드><도로명건물부번호코드>00000</도로명건물부번호코드><도로명시군구코드>11140</도로명시군구코드><도로명일련번호코드>04</도로명일련번호코드><도로명지상지하코드>0</도로명지상지하코드><도로명코드>3101004</도로명코드><법정동> 회현동1가</법정동><법정동본번코드>0208</법정동본번코드><법정동부번코드>0000</법정동부번코드><법정동시군구코드>11140</법정동시군구코드><법정동읍면동코드>12100</법정동읍면동코드><법정동지번코드>1</법정동지번코드><아파트>남산롯데캐슬아이리스</아파트><월>1</월><일>8</일><일련번호>11140-1142</일련번호><전용면적>133.98</전용면적><중개사소재지> </중개사소재지><지번>208</지번><지역코드>11140</지역코드><층>26</층><해제사유발생일> </해제사유발생일><해제여부> </해제여부>
  // 주소를 넘기거나 함수를 호출하거나
  function makeList(data) {
    document.querySelector("#t").setAttribute("style", "display: ;");
    let tbody = document.querySelector("#aptlist");
    let parser = new DOMParser();
    const xml = parser.parseFromString(data, "application/xml");
    // console.log(xml);
    initTable();
    let apts = xml.querySelectorAll("item");
    let dongSel = document.querySelector("#dong");
    let dong = dongSel[dongSel.selectedIndex].text.trim();
    
    console.log(apts);
    apts.forEach((apt) => {
      let nowDong = apt.querySelector("법정동").textContent.trim();

      if(dong === nowDong){
        console.log("ok");
        let tr = document.createElement("tr");

        let nameTd = document.createElement("td");
        nameTd.appendChild(document.createTextNode(apt.querySelector("아파트").textContent));
        tr.appendChild(nameTd);

        let floorTd = document.createElement("td");
        floorTd.appendChild(document.createTextNode(apt.querySelector("층").textContent));
        tr.appendChild(floorTd);

        let areaTd = document.createElement("td");
        areaTd.appendChild(document.createTextNode(apt.querySelector("전용면적").textContent));
        tr.appendChild(areaTd);

        let dongTd = document.createElement("td");
        dongTd.appendChild(document.createTextNode(apt.querySelector("법정동").textContent));
        tr.appendChild(dongTd);

        let priceTd = document.createElement("td");
        priceTd.appendChild(
          document.createTextNode(apt.querySelector("거래금액").textContent + "만원"),
        );
        priceTd.classList.add("text-end");

        tr.appendChild(priceTd);

        tbody.appendChild(tr);

        let res = apt.querySelector("도로명").textContent + apt.querySelector("도로명건물본번호코드").textContent;
        let res2 = apt.querySelector("아파트").textContent;
        makeMakerPre(res, res2, apt);
      }
    });
  }

  function initTable() {
    let tbody = document.querySelector("#aptlist");
    let len = tbody.rows.length;
    for (let i = len - 1; i >= 0; i--) {
      tbody.deleteRow(i);
    }
  }
  var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
      mapOption = {
          center: new kakao.maps.LatLng(37.5012743, 127.039585), // 지도의 중심좌표
          level: 3 // 지도의 확대 레벨
      };  

  // 지도를 생성합니다    
  var map = new kakao.maps.Map(mapContainer, mapOption); 

  // 주소-좌표 변환 객체를 생성합니다
  var geocoder = new kakao.maps.services.Geocoder();

  // 주소로 좌표를 검색합니다

  function makeMakerPre(str, str2, apt) {
    geocoder.addressSearch(str, function(result, status) {

    // 정상적으로 검색이 완료됐으면 
    if (status === kakao.maps.services.Status.OK) {

        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
        console.log(coords);

        // 결과값으로 받은 위치를 마커로 표시합니다
        var marker = new kakao.maps.Marker({
            map: map,
            position: coords
        });

        // 인포윈도우로 장소에 대한 설명을 표시합니다
        var infowindow = new kakao.maps.InfoWindow({
            content: `<div style="width:150px;text-align:center;padding:6px 0;">${str2}</div>`
        });
        infowindow.open(map, marker);

        // 마커에 click 이벤트를 등록합니다
        kakao.maps.event.addListener(
          marker,
          "click",
          makeClickListener(map, marker, infowindow, apt),
        );

        // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
        map.setCenter(coords);
    } 
    });  
  } 

  // 인포윈도우를 닫는 클로저를 만드는 함수입니다
  function makeOutListener(map, infowindow, marker, apt) {
    console.log("jkj");

    

    let str = "이름: " + apt.querySelector("아파트").textContent + `<br>` +

              "면적: " + apt.querySelector("전용면적").textContent + `<br>` +

              "거래금액: " + apt.querySelector("거래금액").textContent + "만원" + `<br>` +

              "거래날짜: " + apt.querySelector("년").textContent + "년 " + apt.querySelector("월").textContent + "월 " + apt.querySelector("일").textContent + "일";

    

    infowindow = new kakao.maps.InfoWindow({
      content : `<div style="width:250px;text-align:center;padding:6px 0;">${str}</div>`,
      removable : true
    });
    infowindow.open(map, marker);
  }

  

  function makeClickListener(map, marker, infowindow, apt) {
    return function () {
      var pos = marker.getPosition();
      console.log(pos);
      map.setLevel(5);
      map.panTo(pos);

      // let table = document.querySelector("#t");
      // table.style.display = "none";
      makeOutListener(map, infowindow, marker, apt);

    };
  }
  
  function makeMarker(data) {
    let parser = new DOMParser();
    const xml = parser.parseFromString(data, "application/xml");
    // console.log(xml);
    let apts = xml.querySelectorAll("item");

    let positions = [];
    let items = xml.getElementsByTagName("item");
    for (let item of items) {
      positions.push({
        title: `${item.getElementsByTagName("yadmNm")[0].textContent}`,
        content: `<div class="info">${
          item.getElementsByTagName("yadmNm")[0].textContent
        }</div>`,
        latlng: new kakao.maps.LatLng(
          `${item.getElementsByTagName("YPosWgs84")[0].textContent}`,
          `${item.getElementsByTagName("XPosWgs84")[0].textContent}`,
        ),
      });
    }
    console.log(positions);

    // 마커 이미지의 이미지 주소입니다
    var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";
    for (var i = 0; i < positions.length; i++) {
      // 마커 이미지의 이미지 크기 입니다
      var imageSize = new kakao.maps.Size(24, 35);

      // 마커 이미지를 생성합니다
      var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

      // 마커를 생성합니다
      var marker = new kakao.maps.Marker({
        map: map, // 마커를 표시할 지도
        position: positions[i].latlng, // 마커를 표시할 위치
        title: positions[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
        image: markerImage, // 마커 이미지
      });

      // 마커에 표시할 인포윈도우를 생성합니다
      var infowindow = new kakao.maps.InfoWindow({
        content: positions[i].content, // 인포윈도우에 표시할 내용
      });

      // 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다
      // 이벤트 리스너로는 클로저를 만들어 등록합니다
      // for문에서 클로저를 만들어 주지 않으면 마지막 마커에만 이벤트가 등록됩니다
      kakao.maps.event.addListener(
        marker,
        "mouseover",
        makeOverListener(map, marker, infowindow),
      );
      kakao.maps.event.addListener(marker, "mouseout", makeOutListener(infowindow));

      // 마커에 click 이벤트를 등록합니다
      kakao.maps.event.addListener(
        marker,
        "click",
        // makeClickListener(map, marker, infowindow),
      );
    }

    //  지도의 중심을 첫번째 요양병원으로 이동.
    // 이동할 위도 경도 위치를 생성합니다
    var moveLatLon = new kakao.maps.LatLng(positions[0].latlng.Ma, positions[0].latlng.La);

    // 지도의 레벨 변경.
    map.setLevel(6);
    // 지도 중심을 이동 시킵니다
    map.setCenter(moveLatLon);
  }
</script>
</body>
</html>